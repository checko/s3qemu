# copy-paste these into the guest shell or mount a 9p share if you prefer
cat > 40_guest_helpers.sh <<'EOF'; chmod +x 40_guest_helpers.sh; ./40_guest_helpers.sh; EOF
#!/bin/sh
set -e
cat /sys/power/mem_sleep
echo deep > /sys/power/mem_sleep
mount -t tracefs tracefs /sys/kernel/tracing 2>/dev/null || true
T=/sys/kernel/tracing
echo nop > $T/current_tracer
echo function_graph > $T/current_tracer
echo > $T/set_ftrace_filter
echo 'pm_*'         >> $T/set_ftrace_filter
echo 'dpm_*'        >> $T/set_ftrace_filter
echo 'suspend_*'    >> $T/set_ftrace_filter
echo 'resume_*'     >> $T/set_ftrace_filter
echo 1 > $T/tracing_on
echo 1 > /sys/power/pm_print_times 2>/dev/null || true
echo "Configured ftrace. Use ./50_suspend_rtc.sh to test suspend."
EOF

cat > 50_suspend_rtc.sh <<'EOF'; chmod +x 50_suspend_rtc.sh
#!/bin/sh
set -e
SEC="${1:-5}"
echo 0 > /sys/class/rtc/rtc0/wakealarm
echo "+$SEC" > /sys/class/rtc/rtc0/wakealarm
echo "Suspending to deep for ~${SEC}s ..."
echo mem > /sys/power/state
T=/sys/kernel/tracing
echo 0 > $T/tracing_on
cat $T/trace > /tmp/pm.trace
echo "Resume done. Trace saved to /tmp/pm.trace"
grep -E 'suspend_enter|resume_resume|pm_suspend|suspend_devices_and_enter|dpm_' /tmp/pm.trace | head -50 || true
EOF

# now run the test
./50_suspend_rtc.sh 5

